# RFMon 频谱监测与占用率分析工具

## 项目简介
本项目是一个基于 **RTL-SDR** 的宽带 NFM（窄带调频）信号扫描、记录、聚合与可视化分析工具，能够：
1. **实时扫描** 指定频段内的无线电信号，并记录活动情况（支持双占空比指标）。
2. **聚合处理** 多个扫描 CSV 文件，将相邻、频率接近的信号合并为连续段。
3. **生成报告**，包括时频图、周活跃度热力图、频率占用率统计，并以 HTML+图片的形式展示。

---

## 目录结构
```
rfmon.py         # 实时扫描与记录算法
aggr.py          # 扫描结果聚合算法
report.py        # 可视化与HTML报告生成算法
requirements.txt # Python依赖
```

---

## 依赖安装

### 1. 系统准备
- 支持 **Linux / macOS / Windows**  
- 安装 **RTL-SDR 驱动** 并确保 `rtl_test` 可正常运行  
- 建议使用 Python 3.9+  

### 2. Python 环境
```bash
pip install -r requirements.txt
```

---

## 核心算法与检测原理

### 检测流程
1. **FFT 分析**  
   将接收到的 IQ 数据进行快速傅里叶变换（FFT），得到频谱功率分布。  
2. **阈值判定**  
   计算背景噪声（中位数或绝对阈值），超过设定阈值的 bin 视为“活跃”。  
3. **簇合并（Cluster Merge）**  
   将连续的活跃 bin 合并为信号簇，计算中心频率和最大功率。  
4. **占空比计算**  
   - **Duty（单 bin 占空比）**：只看信号簇中心频率 bin 是否超过阈值的时间比例。  
   - **Duty_wide（簇范围占空比）**：看整个信号簇活跃的时间比例。  

### Duty 与 Duty_wide 的区别与作用
- **Duty（单 bin 占空比）**
  - 优点：对窄带、频率稳定的信号（如 NFM、CW）敏感，可精确捕捉短时弱信号。
  - 缺点：对宽带或漂移信号可能漏检。
- **Duty_wide（簇范围占空比）**
  - 优点：对宽带、漂移信号（如 AM、SSB）稳健，减少漏检。
  - 缺点：对非常窄的信号可能稍显保守。
- **并存原因**：两者互补，Duty 精确，Duty_wide 稳健，可根据实际需要选择或结合使用。


### 功率标准差（Power Std）的作用
- **定义**：统计信号段内每个采样的功率值的标准差。
- **意义**：反映信号强度的波动情况。
- **长时间占用且标准差小**：通常表示信号源稳定，极有可能来自固定发射台（如中继台）。
  - 中继台发射功率和位置固定，传播路径稳定，因此接收功率波动极小。
- **直频通信（多个移动终端）**：由于终端位置、发射功率、传播路径不同，接收功率波动较大，标准差通常会明显增加。
- **用途**：结合占用率和功率标准差，可以辅助区分固定台与多终端信号源。

### NFM / AM / SSB 检测能力
- 设计参数（如检测带宽、合并公差）更适配 NFM，因此对 NFM 更敏感。
- 算法基于能量检测，与调制方式无关，因此 AM、SSB 只要信号能量高于阈值，同样会被检测到。
- 对 AM/SSB 建议关注 **Duty_wide** 指标以避免中心 bin 漏检问题。

---

## 标准使用方法

### 1. 扫描
```bash
python rfmon.py --f-start 440 --f-stop 450 --samp 2.4 --dwell 5 --auto-threshold 6.0
```

### 2. 聚合
```bash
python aggr.py --dir ./ --out aggregated_signals.csv
```

### 3. 生成报告
```bash
python report.py
```

生成的报告位于 `report/` 目录。

---

## 我的使用方法（Raspberry Pi 5 + RTL-SDR）

我使用 **tmux** 同时运行三个窗口：

1. **持续扫描（窗口1）**
```bash
python3 rfmon_v2.py --f-start 400 --f-stop 520 --samp 2 --dwell 1 --gain 20 --overlap 10 --auto-threshold 16
```

2. **HTTP 报告浏览（窗口2）**
```bash
python3 -m http.server 8000 --directory report
```
然后访问 `http://<Pi5_IP>:8000/report.html` 查看报告。

3. **周期性聚合与报告生成（窗口3）**
```bash
python3 aggr.py && python3 report.py
```
可加入 `cron` 定时任务，例如每小时更新：
```bash
0 * * * * cd /path/to/project && python3 aggr.py && python3 report.py
```

---

## HTML 报告使用说明
1. **顶部时间窗口选择**：切换查看不同时间段的时频图。
2. **底部频率标签**：
   - 标签颜色与时频图一致。
   - 背景填充表示占用率（绿色<30%、黄色30–70%、红色>70%）。
3. **详情视图**：
   - 左侧：周活跃度热力图。
   - 右侧：信号记录表（时间、功率、占空比）。

---

## 示例截图
![报告截图](./Screenshot%202025-08-15%20at%2021-13-23%20Spectrum%20Occupancy%20Report.png)

---

## 许可证
本项目基于 **MIT License** 开源，允许商业和非商业使用，但需保留原作者版权声明。

详细见 [LICENSE](./LICENSE)。
